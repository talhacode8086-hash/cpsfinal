<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyboard Polling Rate - AssetsToolsHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="sidebar.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tool-container {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        .rate-display {
            background: #0d1117;
            border: 4px solid #374151;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .rate-val {
            font-size: 3.5rem;
            font-weight: 900;
            color: white;
            line-height: 1;
        }

        .rate-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .input-area {
            background: var(--card-bg);
            border: 2px dashed var(--primary);
            padding: 2rem;
            border-radius: 2rem;
            margin: 2rem 0;
            cursor: text;
        }

        .chart-box {
            height: 250px;
            background: #111;
            padding: 1rem;
            border-radius: 1.5rem;
            border: 1px solid var(--card-border);
        }
    </style>
</head>

<body>
    <div class="main-content">
        <div class="tool-container">
            <h1 style="font-size: 2.5rem; font-weight:900; margin-bottom: 1rem;">Keyboard Polling Rate Checker</h1>
            <p style="color:var(--text-muted); margin-bottom: 3rem;">Estimate actual reporting frequency by analyzing
                key timestamps.</p>

            <div class="rate-display">
                <div class="rate-val" id="hz">0</div>
                <div class="rate-label">ESTIMATED Hz</div>
            </div>

            <div class="input-area" tabindex="0" id="area">
                <h2 style="margin-bottom:0.5rem">SMASH KEYS HERE</h2>
                <p style="color:var(--text-muted)">Type rapidly or slide fingers across multiple keys. We look for the
                    smallest time delta.</p>
            </div>

            <div class="chart-box">
                <canvas id="chart"></canvas>
            </div>

            <div style="margin-top:2rem; text-align:left; font-size:0.9rem; color:var(--text-muted)">
                <p><b>Note:</b> Accurate detection requires high activity. Browser timer resolution may limit accuracy
                    to ~1000Hz. If you see exactly 125Hz, 250Hz, 500Hz, or 1000Hz, that's likely your polling rate.</p>
            </div>
        </div>
    </div>

    <script src="layout.js"></script>
    <script>
        const hzEl = document.getElementById('hz');
        const area = document.getElementById('area');

        let diffs = [];
        let lastTime = 0;
        let chart;

        function initChart() {
            const ctx = document.getElementById('chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [], // intervals
                    datasets: [{
                        label: 'Interval Count',
                        data: [],
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Time Delta (ms)' } },
                        y: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        area.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const now = performance.now();

            // We want delta between *events*, regardless of key
            // This is messy because user inputs rarely align perfectly with polling cycles manually
            // BUT: If user slides fingers (wiping keys), events fire as fast as scanner hits them.
            if (lastTime !== 0) {
                let diff = now - lastTime;
                if (diff > 0 && diff < 50) { // filter out slow presses
                    diffs.push(diff);
                    updateAnalysis();
                }
            }
            lastTime = now;
        });

        function updateAnalysis() {
            if (diffs.length < 5) return;

            // Find minimal consistent delta
            // Bin the diffs
            const bins = {};
            diffs.forEach(d => {
                const r = Math.round(d);
                if (!bins[r]) bins[r] = 0;
                bins[r]++;
            });

            // Find peak bin (likely polling interval)
            let maxBin = 0;
            let interval = 8; // Default to 8ms (125hz)

            for (let [k, v] of Object.entries(bins)) {
                if (parseInt(k) <= 0) continue;
                if (v > maxBin) {
                    maxBin = v;
                    interval = parseInt(k);
                }
            }

            // Calculate Hz
            const hz = Math.round(1000 / interval);
            hzEl.innerText = hz;

            // Update Visuals
            const labels = Object.keys(bins).sort((a, b) => a - b);
            const data = labels.map(k => bins[k]);

            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }

        initChart();
        area.focus();
    </script>
</body>

</html>